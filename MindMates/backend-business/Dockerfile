# Stage 1: Build
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /src

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶å¹¶æ¢å¤ä¾èµ– (åˆ©ç”¨ç¼“å­˜)
COPY ["MindMates.sln", "./"]
COPY ["MindMates.Api/MindMates.Api.csproj", "MindMates.Api/"]
COPY ["MindMates.Application/MindMates.Application.csproj", "MindMates.Application/"]
COPY ["MindMates.Domain/MindMates.Domain.csproj", "MindMates.Domain/"]
COPY ["MindMates.Infrastructure/MindMates.Infrastructure.csproj", "MindMates.Infrastructure/"]

# æ¢å¤ä¾èµ–ï¼ˆdotnet restore ä¹Ÿå¯ä»¥é…ç½®æºï¼Œä½†é€šå¸¸æµ·å¤–æºåœ¨æ„å»ºæœºä¸Šå°šå¯ï¼‰
RUN dotnet restore

# å¤åˆ¶å…¨é‡ä»£ç å¹¶å‘å¸ƒ
COPY . .
WORKDIR /src/MindMates.Api
RUN dotnet publish -c Release -o /app/publish --no-restore

# Stage 2: Runtime
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS runtime
WORKDIR /app

# ğŸ”§ ä¿®å¤å…³é”®ï¼šç»Ÿä¸€ä½¿ç”¨ bookworm æºï¼Œä¸å†è·¨ç‰ˆæœ¬ä½¿ç”¨ trixie
RUN sed -i 's/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list.d/debian.sources || \
    sed -i 's/deb.debian.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apt/sources.list && \
    echo 'Acquire::Retries "3";' > /etc/apt/apt.conf.d/80-retries && \
    apt-get update && \
    apt-get install -y --no-install-recommends wget && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºç”¨æˆ·ä¸æƒé™è®¾ç½®
RUN adduser --disabled-password --gecos '' appuser
COPY --from=build /app/publish .
RUN chown -R appuser:appuser /app

USER appuser

# ç¯å¢ƒå˜é‡ä¼˜åŒ–
ENV ASPNETCORE_URLS=http://+:5000 \
    ASPNETCORE_ENVIRONMENT=Production \
    # æ³¨æ„ï¼šå¦‚æœä½ çš„åº”ç”¨æ¶‰åŠå¤šè¯­è¨€å¤„ç†ï¼ˆå¦‚æ—¥æœŸæ ¼å¼åŒ–ï¼‰ï¼Œè¯·æ…ç”¨ INVARIANT=1
    DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1 

EXPOSE 5000

HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:5000/health || exit 1

ENTRYPOINT ["dotnet", "MindMates.Api.dll"]
