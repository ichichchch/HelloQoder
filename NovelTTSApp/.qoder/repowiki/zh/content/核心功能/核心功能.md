# 核心功能

<cite>
**本文档引用的文件**   
- [README.md](file://README.md)
- [Agent&Chat.md](file://docs/Agent&Chat.md)
- [Program.cs](file://src/App/Program.cs)
- [INovelReader.cs](file://src/Core/Interfaces/INovelReader.cs)
- [NovelReader.cs](file://src/Infrastructure/Services/NovelReader.cs)
- [ITextSegmenter.cs](file://src/Core/Interfaces/ITextSegmenter.cs)
- [TextSegmenter.cs](file://src/Infrastructure/Services/TextSegmenter.cs)
- [ITtsService.cs](file://src/Core/Interfaces/ITtsService.cs)
- [ZhipuTtsService.cs](file://src/Infrastructure/Services/ZhipuTtsService.cs)
- [IBilibiliDownloader.cs](file://src/Core/Interfaces/IBilibiliDownloader.cs)
- [BilibiliDownloader.cs](file://src/Infrastructure/Services/BilibiliDownloader.cs)
- [IAudioProcessor.cs](file://src/Core/Interfaces/IAudioProcessor.cs)
- [AudioProcessor.cs](file://src/Infrastructure/Services/AudioProcessor.cs)
</cite>

## 目录
1. [小说文本读取](#小说文本读取)
2. [智能文本分段](#智能文本分段)
3. [AI语音合成](#ai语音合成)
4. [声音克隆](#声音克隆)
5. [音频处理](#音频处理)
6. [智能重试](#智能重试)

## 小说文本读取

该功能支持从本地文件和网络URL两种方式读取小说内容。系统通过`INovelReader`接口定义了统一的读取契约，其具体实现位于`NovelReader`类中。对于本地文件，应用支持`.txt`和`.md`格式，通过异步文件读取操作加载文本内容，并自动提取文件名作为小说标题。对于网络内容，系统能够从指定的URL抓取网页数据，利用`HtmlAgilityPack`库解析HTML结构，通过预设的选择器（如`#content`、`.chapter-content`等）定位正文区域，并进行文本清洗后返回结构化的小说对象。

**Section sources**
- [README.md](file://README.md#L21)
- [INovelReader.cs](file://src/Core/Interfaces/INovelReader.cs#L6-L17)
- [NovelReader.cs](file://src/Infrastructure/Services/NovelReader.cs#L6-L104)

## 智能文本分段

该功能负责将长篇小说文本分割成适合TTS引擎处理的短片段。系统通过`ITextSegmenter`接口和`TextSegmenter`实现类完成此任务。分段逻辑首先按段落进行切分，然后对每个段落进行长度评估。如果单个段落超过预设的最大长度（默认500字符），则进一步按句子拆分。系统使用正则表达式识别中文和英文的句末标点（如句号、感叹号、问号）作为断句依据。在分段前，文本会经过清洗处理，包括去除HTML标签、规范化空白字符和移除特殊符号，以确保TTS处理的文本质量。最终，文本被分割为一个有序的`TextSegment`对象列表，每个对象包含索引和文本内容。

**Section sources**
- [README.md](file://README.md#L22)
- [ITextSegmenter.cs](file://src/Core/Interfaces/ITextSegmenter.cs#L6-L17)
- [TextSegmenter.cs](file://src/Infrastructure/Services/TextSegmenter.cs#L6-L128)

## AI语音合成

该功能基于智谱AI的GLM-TTS模型实现高质量的文本到语音转换。系统通过`ITtsService`接口与`ZhipuTtsService`实现类集成智谱的API。核心实现通过调用`audio/speech`端点，将文本输入转换为WAV格式的音频流。服务支持两种模式：`GenerateSpeechAsync`用于生成完整的音频文件并保存到临时目录；`StreamSpeechAsync`用于流式传输音频数据，实现低延迟的实时语音生成。系统会根据配置中的API密钥、模型ID和端点URL构建HTTP请求，并处理二进制音频响应。生成的音频片段被封装为`AudioSegment`对象，包含文件路径、时长和状态信息，供后续的音频处理流程使用。

**Section sources**
- [README.md](file://README.md#L23)
- [ITtsService.cs](file://src/Core/Interfaces/ITtsService.cs#L6-L24)
- [ZhipuTtsService.cs](file://src/Infrastructure/Services/ZhipuTtsService.cs#L8-L391)

## 声音克隆

该功能允许用户从Bilibili视频中提取音频，创建个性化的克隆音色。整个流程分为四个明确的步骤：
1.  **音频提取**：系统通过`BilibiliDownloader`类，利用B站提供的API获取视频的CID和BVID信息，并解析出最高质量的音频流URL，将其下载为本地M4A文件。
2.  **音频上传**：将提取的音频文件通过智谱AI的`files` API端点上传，上传时指定`purpose`为`voice-clone-input`，成功后获得`file_id`。
3.  **音色创建**：调用智谱的`voice/clone` API，传入上一步获得的`file_id`、一个唯一的音色名称以及示例文本，API处理后返回`voice_id`。
4.  **语音生成**：在调用`audio/speech` API生成语音时，将`voice_id`作为`voice`参数传入，即可生成与参考音频音色一致的语音。

此功能通过`IBilibiliDownloader`接口和`CreateVoiceReferenceAsync`方法实现，支持指定音频的起始时间和持续时间，以截取最合适的10秒参考片段。

**Section sources**
- [README.md](file://README.md#L24-L160)
- [IBilibiliDownloader.cs](file://src/Core/Interfaces/IBilibiliDownloader.cs#L6-L25)
- [BilibiliDownloader.cs](file://src/Infrastructure/Services/BilibiliDownloader.cs#L6-L176)
- [ZhipuTtsService.cs](file://src/Infrastructure/Services/ZhipuTtsService.cs#L193-L259)

## 音频处理

该功能负责对TTS生成的多个音频片段进行后期处理，最终合成完整的有声书文件。系统通过`IAudioProcessor`接口和`AudioProcessor`类，利用NAudio库实现核心音频操作。主要功能包括：
- **音频合并**：`MergeAudioSegmentsAsync`方法将所有成功生成的音频片段按顺序读取、解码，并统一重采样至44.1kHz、16位、单声道的标准格式后，合并写入一个单一的WAV文件。
- **格式转换**：`ConvertFormatAsync`方法支持将音频文件转换为不同格式。目前原生支持WAV格式，MP3格式转换需要额外的编码库支持。
- **音频裁剪**：`TrimAudioAsync`方法允许从参考音频中精确截取指定时间段的片段，用于声音克隆。
- **时长获取**：`GetDurationAsync`方法用于读取音频文件的总时长，以便在日志和进度报告中显示。

该模块确保了生成的有声书在格式和质量上的一致性。

**Section sources**
- [README.md](file://README.md#L25)
- [IAudioProcessor.cs](file://src/Core/Interfaces/IAudioProcessor.cs#L6-L38)
- [AudioProcessor.cs](file://src/Infrastructure/Services/AudioProcessor.cs#L6-L231)

## 智能重试

该功能增强了系统对API调用失败的容错能力，确保在面对网络波动或服务限流时能够稳定运行。系统集成了Polly库，在`ZhipuTtsService`中为关键的API调用（如TTS生成和声音克隆）配置了弹性重试策略。该策略定义了最多3次重试，采用指数退避（exponential backoff）的延迟方式，初始延迟为2秒。重试条件涵盖了`HttpRequestException`（网络请求异常）和`TaskCanceledException`（任务取消异常），特别处理了HTTP 429（请求过多）等常见错误。通过`ResiliencePipeline`构建的管道，所有API调用都经过此策略的保护，大大提高了系统在不稳定网络环境下的鲁棒性。

**Section sources**
- [README.md](file://README.md#L26)
- [ZhipuTtsService.cs](file://src/Infrastructure/Services/ZhipuTtsService.cs#L22-L32)